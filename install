#!/bin/zsh
set -e

# Install script

echo -n -e "\033]0;Install & update dotfiles for macOS\007"

# Navigate to home directory
cd ~

# Ask for the administrator password upfront
sudo -v

# Keep sudo session persistent
while true; do sudo -n true; sleep 60; kill -0 "$$" || exit; done 2>/dev/null &

# Validate yourself and as admin
[ "$USER" = "root" ] && abort "Run this script as yourself, not root."
groups | grep $Q -E "\b(admin)\b" || abort "Add $USER to the admin group."

# Prevent sleeping during script execution, as long as the machine is on AC power
caffeinate -s -w $$ &



# Set some variables to use during install
echo "Phonenumber for lock screen message:"
read -r PHONENUMBER
echo "Computer network name:"
read -r PCNAME



# Check for macOS updates
touch /tmp/.com.apple.dt.CommandLineTools.installondemand.in-progress;
# TODO: enable sudo softwareupdate -i -a --restart
rm /tmp/.com.apple.dt.CommandLineTools.installondemand.in-progress



HOMEBREW_NO_ANALYTICS=1
HOMEBREW_BUNDLE_NO_LOCK=1
HOMEBREW_CLEANUP_MAX_AGE_DAYS=0
# Install Homebrew if not already installed
if ! brew -v 2>/dev/null; then
  echo | /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
else
  echo "Homebrew already installed. Updating..."
fi

brew analytics off

# Update brew to latest available version
brew update --quiet && brew upgrade --quiet && brew cleanup --quiet



# Update shell to latest zsh
brew install zsh --quiet

# Change default shell to Homebrew installed zsh
BREW_PREFIX=$(brew --prefix)

if ! fgrep -q "${BREW_PREFIX}/bin/zsh" /etc/shells; then
  echo "${BREW_PREFIX}/bin/zsh" | sudo tee -a /etc/shells;
  sudo chsh -s "${BREW_PREFIX}/bin/zsh";
fi

# Install the latest git
brew install git --quiet



# Install dotfiles
DF_BRANCH="macos"

if [ ! -d "$HOME/.files" ]; then
  git clone --bare https://github.com/JasperV/dotfiles.git $HOME/.files

  # Reset the unstaged changes before updating
  git --git-dir=$HOME/.files --work-tree=$HOME reset --hard

  # Set flag to ignore untracked files
  git --git-dir=$HOME/.files --work-tree=$HOME config --local status.showUntrackedFiles no
  # TODO: prevent adding all untracked files
fi

git --git-dir=$HOME/.files --work-tree=$HOME checkout $DF_BRANCH
git --git-dir=$HOME/.files --work-tree=$HOME pull origin $DF_BRANCH



# Install Homebrew packages
brew bundle --quiet --no-lock
brew autoupdate start --upgrade --cleanup --enable-notification
brew cu
brew cleanup --prune=all
brew bundle cleanup --quiet --no-lock --force
rm -rf "$(brew --cache)"



# Install/update Antigen
curl -L git.io/antigen > antigen.zsh



# configure macOS
./.macos



# Reboot
if [[ " $@ " =~ " --no-reboot " ]]; then
    echo "Done."
    exit
fi
echo "Done. Rebooting now!"
sudo shutdown -r now
