#!/bin/bash

set -e

if [[ -z "$NAMESERVER" ]]; then
  echo "set name server to 1.1.1.1"
  NAMESERVER="1.1.1.1"
fi

if [[ -z "$REPO" ]]; then
  REPO="jasperv/dotfiles"
fi

DF_BRANCH="wsl-ubuntu"

if [[ $(lsattr /etc/resolv.conf | awk '$1 !~ "i"') ]]; then
  echo "do remove resolve.conf"
  sudo rm -f /etc/resolv.conf

  echo "nameserver $NAMESERVER" | sudo tee /etc/resolv.conf > /dev/null

  echo "[network]" | sudo tee /etc/wsl.conf > /dev/null
  echo "generateResolvConf = false" | sudo tee -a /etc/wsl.conf > /dev/null

  echo "set attr +i on resolve.conf"
  sudo chattr +i /etc/resolv.conf
fi

# Update and upgrade
sudo apt-get update -y && sudo apt-get upgrade -y

# Install Homebrew
if ! brew -v 2>/dev/null; then
  # ohai "Install Homebrew"
  echo | /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
  (echo; echo 'eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"') >> /home/jasper/.bashrc
  eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"

  sudo apt-get install build-essential

  brew install gcc
fi

# Disable brew analytics
brew analytics off

# Update brew to latest available version
# ohai "Update Homebrew"
brew update --quiet && brew upgrade --quiet && brew cleanup --quiet

# Download Brewfile if not exists
if [ ! -f "$HOME/Brewfile" ]; then
  # ohai "Downloading Brewfile"
  curl -o Brewfile -fsSL https://raw.githubusercontent.com/$REPO/$DF_BRANCH/Brewfile
fi

# Install Homebrew packages
# ohai "Install Homebrew packages"
brew bundle --quiet --no-lock || true

# Cleanup after brew
# ohai "Cleanup after Homebrew"
brew cu -a -y -q
brew cleanup --prune=all
brew bundle cleanup --quiet --no-lock --force
sudo rm -rf "$(brew --cache)"

# Install dotfiles
if [ ! -d "$HOME/.files" ]; then
  # ohai "Clone $REPO into $HOME/.files"

  git clone --bare "https://github.com/$REPO.git" "$HOME/.files"

  # Reset the unstaged changes before updating
  git --git-dir=$HOME/.files --work-tree=$HOME reset --hard

  # Set flag to ignore untracked files
  git --git-dir=$HOME/.files --work-tree=$HOME config --local status.showUntrackedFiles no
fi

if [[ `git --git-dir=$HOME/.files --work-tree=$HOME status --porcelain` ]]; then
  # warn "local changes to dotfiles found, not updating from origin"
  echo "local changes!"
else
  git --git-dir=$HOME/.files --work-tree=$HOME checkout $DF_BRANCH
  git --git-dir=$HOME/.files --work-tree=$HOME pull origin $DF_BRANCH
fi

# Change default shell to Homebrew installed Zsh
BREW_ZSH_LOCATION="$(brew --prefix)/bin/zsh"

if ! fgrep -q $BREW_ZSH_LOCATION /etc/shells; then
  # ohai "Use Homebrew installed ZSH"
  echo $BREW_ZSH_LOCATION | sudo tee -a /etc/shells
  sudo chsh -s $BREW_ZSH_LOCATION $USER
fi

# TODO: Configure Ubuntu and Applications

# Silence the default terminal welcome message
touch .hushlogin

# TODO: Prepare folders to use for Insync
mkdir -p src

success "âœ”  Done!"
