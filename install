#!/bin/zsh
set -e

# Install script

echo -n -e "\033]0;Install dotfiles for macOS\007"

# Navigate to home directory
cd ~

# Ask for the administrator password upfront
sudo -v

# Keep sudo session persistent
while true; do sudo -n true; sleep 60; kill -0 "$$" || exit; done 2>/dev/null &

# Validate yourself and as admin
[ "$USER" = "root" ] && abort "Run this script as yourself, not root."
groups | grep $Q -E "\b(admin)\b" || abort "Add $USER to the admin group."

# Prevent sleeping during script execution, as long as the machine is on AC power
caffeinate -s -w $$ &



# Check for macOS updates
touch /tmp/.com.apple.dt.CommandLineTools.installondemand.in-progress;
# TODO: enable sudo softwareupdate -i -a --restart
rm /tmp/.com.apple.dt.CommandLineTools.installondemand.in-progress



# TODO: move these to exports as well
HOMEBREW_NO_ANALYTICS=1
HOMEBREW_BUNDLE_NO_LOCK=1
HOMEBREW_CLEANUP_MAX_AGE_DAYS=0
# Install Homebrew if not already installed
if ! brew -v 2>/dev/null; then
  echo | /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
fi

brew analytics off

# Update brew to latest available version
brew update --quiet



# Update shell to latest zsh
brew install zsh --quiet
# TODO: asks for password

# Change default shell to Homebrew installed zsh
BREW_PREFIX=$(brew --prefix) # TODO: add to environment! in source file

if ! fgrep -q "${BREW_PREFIX}/bin/zsh" /etc/shells; then
  echo "${BREW_PREFIX}/bin/zsh" | sudo tee -a /etc/shells;
  sudo chsh -s "${BREW_PREFIX}/bin/zsh";
fi

# Install the latest git
brew install git --quiet



# Install dotfiles
DF_BRANCH="macos"

if [ ! -d "$HOME/.files" ]; then
  git clone --bare https://github.com/JasperV/dotfiles.git $HOME/.files
fi

# Reset the unstaged changes before updating
git --git-dir=$HOME/.files --work-tree=$HOME reset --hard

# Set flag to ignore untracked files
git --git-dir=$HOME/.files --work-tree=$HOME config --local status.showUntrackedFiles no
# TODO: prevent adding all untracked files

git --git-dir=$HOME/.files --work-tree=$HOME checkout $DF_BRANCH
git --git-dir=$HOME/.files --work-tree=$HOME pull origin $DF_BRANCH



# Install Homebrew packages
brew bundle --quiet --no-lock
brew cleanup --prune=all
rm -rf "$(brew --cache)"



# Install Antigen
curl -L git.io/antigen > antigen.zsh
# TODO: can there be more than one antigen use...?
# https://github.com/belak/zsh-utils
# https://github.com/intelfx/pure



# configure macOS
# TODO: fix errors in macos config
./.macos



# Reboot
echo "Done. Rebooting now!"
# sudo shutdown -r now
